---
title: 從Asp.net框架角度進入Asp.net MVC原始碼- (第28天)
date: 
tags: [C#,Asp.net,Asp.net-MVC,SourceCode,11th鐵人賽]
categories: [C#]
---

# Agenda<!-- omit in toc -->
- [前言](#%e5%89%8d%e8%a8%80)
- [建立自己的IActionInvoker(CustomerActionInvoker)](#%e5%bb%ba%e7%ab%8b%e8%87%aa%e5%b7%b1%e7%9a%84iactioninvokercustomeractioninvoker)

## 前言

今天要分享對於`ActionInvoker`進行替換成自己客制化的`IActionInvoker`

在**MVC**原始碼中有個`CreateActionInvoker`方法來取得一個`IActionInvoker`物件,可以看到她會先透過`Resolver.GetService`從解析器中取得我們的`IActionInvoker`如果沒有在`new`一個`AsyncControllerActionInvoker`物件.

```csharp
protected virtual IActionInvoker CreateActionInvoker()
{
    IAsyncActionInvokerFactory asyncActionInvokerFactory = Resolver.GetService<IAsyncActionInvokerFactory>();
    if (asyncActionInvokerFactory != null)
    {
        return asyncActionInvokerFactory.CreateInstance();
    }
    IActionInvokerFactory actionInvokerFactory = Resolver.GetService<IActionInvokerFactory>();
    if (actionInvokerFactory != null)
    {
        return actionInvokerFactory.CreateInstance();
    }

    // Note that getting a service from the current cache will return the same instance for every request.
    return Resolver.GetService<IAsyncActionInvoker>() ??
        Resolver.GetService<IActionInvoker>() ??
        new AsyncControllerActionInvoker();
}
```

我們解析器一樣使用`Autofac`容器來幫我們完成(所以程式碼會基於昨天的Autofac在往上加

## 建立自己的IActionInvoker(CustomerActionInvoker)

```csharp
public class CustomerActionInvoker : IActionInvoker
{
    public bool InvokeAction(ControllerContext controllerContext, string actionName)
    {
        //取得執行Action方法
        MethodInfo method = controllerContext.Controller
            .GetType()
            .GetMethods()
            .First(m => string.Compare(actionName, m.Name, StringComparison.OrdinalIgnoreCase) == 0);

        //取得Action使用的參數,並利用反射將值填充
        var parameters = method.GetParameters().Select(parameter =>
            BindModel(controllerContext, parameter.Name, parameter.ParameterType));

        ActionResult actionResult = method.Invoke(controllerContext.Controller, parameters.ToArray()) as ActionResult;

        actionResult.ExecuteResult(controllerContext);

        return true;
    }

    private object BindModel(ControllerContext controllerContext,
        string modelName, Type modelType)
    {
        if (modelType.IsValueType || typeof(string) == modelType)
        {
            object instance;
            if (GetValueTypeInstance(controllerContext, modelName, modelType, out instance))
            {
                return instance;
            }
            return Activator.CreateInstance(modelType);
        }

        return SimpleModelBinding(controllerContext, modelType);
    }

    private object SimpleModelBinding(ControllerContext controllerContext, Type modelType)
    {
        object modelInstance = Activator.CreateInstance(modelType);
        foreach (PropertyInfo property in modelType.GetProperties())
        {
            //只針對simple model binding做動作.
            if (!property.CanWrite || (!property.PropertyType.IsValueType && property.PropertyType != typeof(string)))
            {
                continue;
            }

            object propertyValue;
            if (GetValueTypeInstance(controllerContext, property.Name, property.PropertyType, out propertyValue))
            {
                property.SetValue(modelInstance, propertyValue);
            }
        }

        return modelInstance;
    }

    private bool GetValueTypeInstance(ControllerContext controllerContext, string modelName, Type modelType, out object value)
    {
        var form = controllerContext.RequestContext.HttpContext.Request.Form;
        var queryString = controllerContext.RequestContext.HttpContext.Request.QueryString;

        string key = form.AllKeys.FirstOrDefault(x => string.Compare(x, modelName, StringComparison.OrdinalIgnoreCase) == 0);
        if (key != null)
        {
            value = Convert.ChangeType(form[key], modelType);
            return true;
        }

        string queryKey = queryString.AllKeys.FirstOrDefault(x => string.Compare(x, modelName, StringComparison.OrdinalIgnoreCase) == 0);
        if (queryKey != null)
        {
            value = Convert.ChangeType(queryString[queryKey], modelType);
            return true;
        }

        value = null;

        return false;
    }
}
```

```csharp
builder.RegisterType<CustomerActionInvoker>().As<IActionInvoker>();
```