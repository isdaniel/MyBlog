---
title: 從Asp.net框架角度進入Asp.net MVC原始碼-建立自己Route解析機制 (第26天)
date: 
tags: [C#,Asp.net,Asp.net-MVC,SourceCode]
categories: [C#]
---

# Agenda<!-- omit in toc -->
- [前言](#%e5%89%8d%e8%a8%80)
- [RouteData](#routedata)
- [建立自己CustomerRoute](#%e5%bb%ba%e7%ab%8b%e8%87%aa%e5%b7%b1customerroute)

## 前言
	
`UrlRoutingModule`對於`OnPostResolveRequestCache`事件添加一個對於**MVC**很重要的動作,透過`RouteCollection`取得此次請求匹配`RouteData`物件.

利用此`RouteData`取得要使用的`IHttpHandler`來執行它.

```csharp
RouteData routeData = RouteCollection.GetRouteData(context);
```

`RouteCollection`是全域路由註冊表.我們在一開始使用`MapRoute`註冊與之匹配`Controller`和`Action`

> `RouteCollection`是基於`RouteBase`物件集合.

對於每個`Http`請求依序找尋第一個匹配路由規則

```csharp
routes.MapRoute(
    name: "Default",
    url: "{controller}/{action}/{id}",
    defaults: new { controller = "Home", action = "Index", id = UrlParameter.Optional }
);
```

## RouteData

在`RouteData`類別中有幾個重要的屬性.

* `RouteHandler`:存放`IRouteHandler`物件(提供`IHttpHander`並呼叫執行物件)
* `Values`: 一個字典集合,存放Key為`Controller`和`Action`,`Value`是`URL`參數值相對位置參數
* `GetRequiredString`:利用傳入`string`參數對於`Values`字典取匹配名稱.

```csharp
public class RouteData
{
    private RouteValueDictionary _values = new RouteValueDictionary();
    private RouteValueDictionary _dataTokens = new RouteValueDictionary();
    private IRouteHandler _routeHandler;


    /// <summary>
    ///   使用指定的路由及路由處理常式，初始化 <see cref="T:System.Web.Routing.RouteData" /> 類別的新執行個體。
    /// </summary>
    /// <param name="route">此物件會定義路由。</param>
    /// <param name="routeHandler">處理要求的物件。</param>
    public RouteData(RouteBase route, IRouteHandler routeHandler)
    {
      this.Route = route;
      this.RouteHandler = routeHandler;
    }

    /// <summary>
    ///   取得自訂值集合，當 ASP.NET 路由判斷路由是否符合要求時，會將這些值傳遞至路由處理常式但不會使用。
    /// </summary>
    public RouteValueDictionary DataTokens
    {
      get
      {
        return this._dataTokens;
      }
    }

    /// <summary>取得或設定代表路由的物件。</summary>
    public RouteBase Route { get; set; }

    /// <summary>取得或設定處理要求路由的物件。</summary>
    public IRouteHandler RouteHandler
    {
      get
      {
        return this._routeHandler;
      }
      set
      {
        this._routeHandler = value;
      }
    }

    /// <summary>取得 URL 參數值和預設路由值的集合。</summary>
    public RouteValueDictionary Values
    {
      get
      {
        return this._values;
      }
    }

    /// <summary>擷取具有指定識別項的值。</summary>
    public string GetRequiredString(string valueName)
    {
      object obj;
      if (this.Values.TryGetValue(valueName, out obj))
      {
        string str = obj as string;
        if (!string.IsNullOrEmpty(str))
          return str;
      }
      throw new InvalidOperationException(string.Format((IFormatProvider) CultureInfo.CurrentUICulture, System.Web.SR.GetString("RouteData_RequiredValue"), new object[1]
      {
        (object) valueName
      }));
    }
}
```

`RouteData`主要存放`Client`傳送**Http**請求和匹配`Route`資訊.

## 建立自己CustomerRoute
