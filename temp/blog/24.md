---
title: 從Asp.net框架角度進入Asp.net MVC原始碼－View (第24天)
date: 
tags: [C#,Asp.net,Asp.net-MVC,SourceCode]
categories: [C#]
---

# Agenda<!-- omit in toc -->
- [前言](#%e5%89%8d%e8%a8%80)
- [ViewResultBase.ExecuteResult](#viewresultbaseexecuteresult)
- [IView](#iview)
- [IViewEngine](#iviewengine)
  - [ViewEngineResult](#viewengineresult)

## 前言

繼承`ActiontResult`類別中`ViewResultBase`最為複雜,因為`ViewResultBase`要找到實現`IViewEngine`物件取得取得`View`檔案,在透過實現`IView`物件把頁面渲染出來.

這篇會跟大家分享值型上面動作核心類別.

個人覺得**MVC**運用很多物件導向概念和用法,在讀程式時有件事情很重要是理解類別負責的工作和類別之間關係.就像現實生活中人與人的關係要了解清楚.

## ViewResultBase.ExecuteResult

因為`ExecuteResult`是最終被呼叫方法,我們來解析`ViewResultBase.ExecuteResult`方法邏輯.

1. 透過子類別實現`FindView`取得`View`相關資料.
2. 呼叫實現`IView`物件`Render`方法,並將渲染出來資料透過`Response.Output`輸出到`Client`端

```csharp
public override void ExecuteResult(ControllerContext context)
{
    if (context == null)
    {
        throw new ArgumentNullException("context");
    }
    if (String.IsNullOrEmpty(ViewName))
    {
        ViewName = context.RouteData.GetRequiredString("action");
    }

    ViewEngineResult result = null;

    if (View == null)
    {
        result = FindView(context);
        View = result.View;
    }

    TextWriter writer = context.HttpContext.Response.Output;
    ViewContext viewContext = new ViewContext(context, View, ViewData, TempData, writer);
    View.Render(viewContext, writer);

    if (result != null)
    {
        result.ViewEngine.ReleaseView(context, View);
    }
}

protected abstract ViewEngineResult FindView(ControllerContext context);
```

## IView

**ASP.NET MVC**為我們提供了兩種`View`引擎(`RazorViewEngine`,`WebFormViewEngine`)，

* 提供傳統**Web Form**引擎，`.aspx`頁面一致`WebFormViewEngine`，
* 另一種預設使用也是推薦使用**Razor**引擎`RazorViewEngine`。

> View是一個實現了`IView`介面物件。`IView`定義非常簡單，僅僅具有唯一`Render`方法根據指定`ViewContext`和`TextWriter`物件實現對`View`渲染顯示

```csharp
public interface IView
{
    void Render(ViewContext viewContext, TextWriter writer);
}
```

## IViewEngine

這個介面提供找尋

```csharp
public interface IViewEngine
{
    ViewEngineResult FindPartialView(ControllerContext controllerContext, string partialViewName, bool useCache);
    ViewEngineResult FindView(ControllerContext controllerContext, string viewName, string masterName, bool useCache);
    void ReleaseView(ControllerContext controllerContext, IView view);
}
```

### ViewEngineResult

```csharp
public class ViewEngineResult
{
	public ViewEngineResult(IEnumerable<string> searchedLocations)
	{
		if (searchedLocations == null)
		{
			throw new ArgumentNullException("searchedLocations");
		}

		SearchedLocations = searchedLocations;
	}

	public ViewEngineResult(IView view, IViewEngine viewEngine)
	{
		if (view == null)
		{
			throw new ArgumentNullException("view");
		}
		if (viewEngine == null)
		{
			throw new ArgumentNullException("viewEngine");
		}

		View = view;
		ViewEngine = viewEngine;
	}

	public IEnumerable<string> SearchedLocations { get; private set; }

	public IView View { get; private set; }

	public IViewEngine ViewEngine { get; private set; }
}
```

