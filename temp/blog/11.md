---
title: Asp.net架構 & Asp.net MVC 原始碼－ Asp.net MVC 控制器解析(一) (第11天)
date: 
tags: [C#,Asp.net,Asp.net-MVC,SourceCode]
categories: [C#]
---
# Agenda<!-- omit in toc -->
- [前言](#%E5%89%8D%E8%A8%80)
- [取得Controller](#%E5%8F%96%E5%BE%97Controller)

## 前言

前篇介紹MVC使用`HttpHandler`是`MvcHandler`透過並`MvcRouteHandler`物件來返回.

![relationship_pic.PNG](https://raw.githubusercontent.com/isdaniel/MyBlog/master/source/images/itHelp/10/relationship_pic.PNG)

我有做一個可以針對於[Asp.net MVC Debugger](https://github.com/isdaniel/Asp.net-MVC-Debuger)的專案，只要下中斷點就可輕易進入Asp.net MVC原始碼.

大家介紹如何取得`Controller`執行物件


## 取得Controller

在`ProcessRequest`方法是透過`ProcessRequestInit`取得執行`controller`物件,讓我們看看是這個方法如何`controller`物件.

```csharp
private void ProcessRequestInit(HttpContextBase httpContext, out IController controller, out IControllerFactory factory)
{
    // If request validation has already been enabled, make it lazy. This allows attributes like [HttpPost] (which looks
    // at Request.Form) to work correctly without triggering full validation.
    // Tolerate null HttpContext for testing.
    HttpContext currentContext = HttpContext.Current;
    if (currentContext != null)
    {
        bool? isRequestValidationEnabled = ValidationUtility.IsValidationEnabled(currentContext);
        if (isRequestValidationEnabled == true)
        {
            ValidationUtility.EnableDynamicValidation(currentContext);
        }
    }

    AddVersionHeader(httpContext);
    RemoveOptionalRoutingParameters();

    // Get the controller type
    string controllerName = RequestContext.RouteData.GetRequiredString("controller");

    // Instantiate the controller and call Execute
    factory = ControllerBuilder.GetControllerFactory();
    controller = factory.CreateController(RequestContext, controllerName);
    if (controller == null)
    {
        throw new InvalidOperationException(
            String.Format(
                CultureInfo.CurrentCulture,
                MvcResources.ControllerBuilder_FactoryReturnedNull,
                factory.GetType(),
                controllerName));
    }
}


/// <summary>Retrieves the value with the specified identifier.</summary>
/// <param name="valueName">The key of the value to retrieve.</param>
/// <returns>The element in the <see cref="P:System.Web.Routing.RouteData.Values" /> property whose key matches <paramref name="valueName" />.</returns>
/// <exception cref="T:System.InvalidOperationException">A value does not exist for <paramref name="valueName" />.</exception>
public string GetRequiredString(string valueName)
{
    object obj;
    if (this.Values.TryGetValue(valueName, out obj))
    {
    string str = obj as string;
    if (!string.IsNullOrEmpty(str))
        return str;
    }
    throw new InvalidOperationException(string.Format((IFormatProvider) CultureInfo.CurrentUICulture, System.Web.SR.GetString("RouteData_RequiredValue"), new object[1]
    {
    (object) valueName
    }));
}
```

1. 取得執行`Controller`名稱透過`RouteData.GetRequiredString`會透過`RouteValueDictionary`
